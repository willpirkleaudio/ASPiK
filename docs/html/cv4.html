<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASPiK SDK: Design the Custom View Objects</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASPiK SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('cv4.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Design the Custom View Objects </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>With the custom view names set in the GUI designer, we can turn our attention to the custom view objects. We have two view objects that we'll discuss first and then we'll look at the custom knob view. All of these controls and their associated structures are contained in the customviews.h and customviews.cpp files that come standard with all ASPiK projects. You are free to use and modify the objects as you like. Since all of the code is available and open-source we won't spend a lot of time on the details here - you are encouraged to use the Forum at the ASPiK website to ask more questions and get help.<br  />
 <br  />
 The custom view objects must be derived from CView at the minimum, though we often use the CControl instead. Because you are designing the view as well as writing the mechanism for passing the <a class="el" href="class_i_custom_view.html" title="Custom View interface to allow plugin core to create safe communication channels with GUI custom view...">ICustomView</a> pointer to the plugin shell, you can implement the interface however you wish. In our example here we will simply derive the custom view from <a class="el" href="class_i_custom_view.html" title="Custom View interface to allow plugin core to create safe communication channels with GUI custom view...">ICustomView</a> (along with CControl) but you could implement this differently if you would like. The WaveView object declaration is shown here. For this document, we will only be discussing the mechanism for communicating with the custom view. Refer to <b>Designing Audio Effects Plugins in C++ 2nd Ed.</b> for details on the view operations. The important stuff is shown in below, consisting of the two <a class="el" href="class_i_custom_view.html" title="Custom View interface to allow plugin core to create safe communication channels with GUI custom view...">ICustomView</a> overrides plus the inclusion of the lock-free ring buffer. Note how the ring-buffer is declared - it will store a queue of double data values; DATA_QUEUE_LEN is defined at the top of the file and is set to 1024 - you can adjust the size as you like.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>WaveView : <span class="keyword">public</span> CControl, <span class="keyword">public</span> <a class="code hl_class" href="class_i_custom_view.html">ICustomView</a> </div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">   WaveView(<span class="keyword">const</span> CRect&amp; size, IControlListener* listener, int32_t tag);</div>
<div class="line">   ~WaveView();</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// --- ICustomView </span></div>
<div class="line">   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_i_custom_view.html#a09b3386cc82f837cf6f04945590cb848">updateView</a>() <span class="keyword">override</span>;</div>
<div class="line">   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_i_custom_view.html#a60c73575c3bba7d0491dd35ec7ae757d">pushDataValue</a>(<span class="keywordtype">double</span> data) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// --- snipped out code... //</span></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">   <span class="comment">// --- lock-free queue for incoming data, sized to DATA_QUEUE_LEN in length</span></div>
<div class="line">   <a class="code hl_class" href="classmoodycamel_1_1_reader_writer_queue.html">moodycamel::ReaderWriterQueue&lt;double, DATA_QUEUE_LEN&gt;</a>* dataQueue = <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
<div class="line"><span class="comment">//</span></div>
<div class="ttc" id="aclass_i_custom_view_html"><div class="ttname"><a href="class_i_custom_view.html">ICustomView</a></div><div class="ttdoc">Custom View interface to allow plugin core to create safe communication channels with GUI custom view...</div><div class="ttdef"><b>Definition:</b> pluginstructures.h:1462</div></div>
<div class="ttc" id="aclass_i_custom_view_html_a09b3386cc82f837cf6f04945590cb848"><div class="ttname"><a href="class_i_custom_view.html#a09b3386cc82f837cf6f04945590cb848">ICustomView::updateView</a></div><div class="ttdeci">virtual void updateView()=0</div></div>
<div class="ttc" id="aclass_i_custom_view_html_a60c73575c3bba7d0491dd35ec7ae757d"><div class="ttname"><a href="class_i_custom_view.html#a60c73575c3bba7d0491dd35ec7ae757d">ICustomView::pushDataValue</a></div><div class="ttdeci">virtual void pushDataValue(double data)</div><div class="ttdef"><b>Definition:</b> pluginstructures.h:1472</div></div>
<div class="ttc" id="aclassmoodycamel_1_1_reader_writer_queue_html"><div class="ttname"><a href="classmoodycamel_1_1_reader_writer_queue.html">moodycamel::ReaderWriterQueue</a></div><div class="ttdef"><b>Definition:</b> readerwriterqueue.h:60</div></div>
</div><!-- fragment --><p>The implementation of the object may be found in customviews.cpp. It uses a circular buffer to store data that will be printed into the waveform view. The circular buffer indexing is what causes the data to move from the left to the right across the screen. The circular buffer is exactly the same length as the view is wide (in pixels) so each slot in the buffer corresponds to one column of pixels in the view. The object works as follows:<br  />
 <br  />
 • the plugin pushes audio data into the custom view, which buffers it in the lock-free ring buffer<br  />
 • the plugin will push some number of samples into the view during one GUI timer ping call; this represents all of the audio data that was acquired during the previous 50 mSec timer interval<br  />
 • after the plugin empties its data into the view, it calls the updateView( ) method to repaint the custom view<br  />
 in the updateView( ) method, the object sorts through the last chunk of samples to find the one with the maximum value - that sample is then added to the circular buffer; afterwards the view invalidates itself, forcing the repaint<br  />
 <br  />
 So, the WaveView object actually paints the maximum value that occurred during each 50 mSec timer interval. The circular buffer holds the samples to be painted; the lock free ring buffer acts as the incoming data buffer that isolates the circular buffer’s data which is the part used for painting. <br  />
 <br  />
 Let’s look at the two <a class="el" href="class_i_custom_view.html" title="Custom View interface to allow plugin core to create safe communication channels with GUI custom view...">ICustomView</a> methods, starting with pushDataValue( ) which simply pushes the next double value into the queue.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> WaveView::pushDataValue(<span class="keywordtype">double</span> data)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">if</span>(!dataQueue) <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// --- add data point, make room if needed</span></div>
<div class="line">   DataQueue-&gt;enqueue(data);</div>
<div class="line">}</div>
<div class="line"><span class="comment">//</span></div>
</div><!-- fragment --><p>The updateView( ) method sorts the buffer for the maximum value and dequeues the information. Notice the loop that empties the queue (try_dequeue( )) while also finding the maximum value. The addWaveDataPoint( ) function adds the max value into the circular buffer. The rest of the object handles the drawing of the data into the view and is discussed in Designing Audio Effects Plugins in C++ 2nd Ed. so it will not be detailed again here.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> WaveView::updateView()</div>
<div class="line">{</div>
<div class="line">   <span class="comment">// --- get the max value that was added to the queue during the last</span></div>
<div class="line">   <span class="comment">//     GUI timer ping interval</span></div>
<div class="line">   <span class="keywordtype">double</span> audioSample = 0.0;</div>
<div class="line">   <span class="keywordtype">double</span> max = 0.0;</div>
<div class="line">   <span class="keywordtype">bool</span> success = dataQueue-&gt;try_dequeue(audioSample);</div>
<div class="line">   <span class="keywordflow">if</span>(success)</div>
<div class="line">   {</div>
<div class="line">      max = audioSample;</div>
<div class="line">      <span class="keywordflow">while</span>(success)</div>
<div class="line">      {</div>
<div class="line">         success = dataQueue-&gt;try_dequeue(audioSample);</div>
<div class="line">         <span class="keywordflow">if</span>(success &amp;&amp; audioSample &gt; max)</div>
<div class="line">            max = audioSample;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// --- add to circular buffer</span></div>
<div class="line">      addWaveDataPoint(fabs(max));</div>
<div class="line">   }</div>
<div class="line">       </div>
<div class="line">   <span class="comment">// --- this will set the dirty flag to repaint the view</span></div>
<div class="line">   invalid();</div>
<div class="line">}</div>
<div class="line"><span class="comment">//</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">ASPiK Developer&#39;s Guide</a></li><li class="navelem"><a class="el" href="gui_design.html">Design a GUI</a></li><li class="navelem"><a class="el" href="define_g_u_i6.html">Advanced GUI Topics</a></li><li class="navelem"><a class="el" href="gui_designer11.html">Custom Views</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
